{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>

    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .container {
            width: 80%;
            margin: auto;
        }

        .chart-container {
            margin: 20px 0;
        }

        .info-box {
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>

<body>

    {% include 'Staff_Headers.html' %}

    <h1><img src="{% static 'images/dash.gif' %}" alt="Dashboard Title" class="dashboard-title-image"></h1>

    <div class="date-filter-container">
        <form id="dateFilterForm" method="GET" action="/dashboard/">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" name="start_date" value="2024-01-24">

            <label for="end_date">End Date:</label>
            <input type="date" id="end_date" name="end_date" value="2024-07-24">

            <button type="submit">Filter</button>
        </form>
    </div>


    <div class="overlay"></div> <!-- Overlay element -->
    <div class="dashboard-container">
        <div class="dashboard-grid">
            <div class="info-box" onclick="toggleAvailableTable()">
                <h2>AVAILABLE COLUMBARIES</h2>
                <p>{{ vacant_columbaries_count }}</p>
            </div>
            <div class="info-box" onclick="toggleOccupiedTable()">
                <h2>OCCUPIED COLUMBARIES</h2>
                <p>{{ occupied_columbaries_count }}</p>
            </div>
            <div class="info-box" onclick="toggleUnissuedTable()">
                <h2>UNISSUED COLUMBARIES</h2>
                <p>{{ unissued_columbaries }}</p>
            </div>
            <div class="info-box" onclick="toggleTable()">
                <h2>PENDING LETTERS OF INTENT</h2>
                <p>{{ pending_counts }}</p>
            </div>
        </div>

        <!-- Pending Letter of Intent Table (Initially Hidden) -->
        <div id="pendingTableContainer" class="table-container hidden">
            <h3>PENDING LETTERS OF INTENT</h3>
            <table>
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Mobile</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in pending_customers %}
                    <tr id="customer-row-{{ customer.customer_id }}">
                        <td>{{ customer.full_name }}</td>
                        <td>{{ customer.email_address }}</td>
                        <td>{{ customer.mobile_number }}</td>
                        <td>
                            <button class="btn-accept"
                                onclick="updateCustomerStatus({{ customer.customer_id }}, 'accept')">Accept</button>
                            <button class="btn-decline"
                                onclick="updateCustomerStatus({{ customer.customer_id }}, 'decline')">Decline</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Available Columbaries Table (Initially Hidden) -->
        <div id="availableTableContainer" class="table-container hidden">
            <h3>AVAILABLE COLUMBARIES</h3>
            <table>
                <thead>
                    <tr>
                        <th>Columbary Name</th>
                        <th>Location</th>
                        <th>Capacity</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for columbary in vacant_columbaries %}
                    <tr>
                        <td>{{ columbary.vault_id }}</td>
                        <td>{{ columbary.section }}</td>
                        <td>{{ columbary.urns_per_columbary }}</td>
                        <td>{{ columbary.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Occupied Columbaries Table (Initially Hidden) -->
        <div id="occupiedTableContainer" class="table-container hidden">
            <h3>OCCUPIED COLUMBARIES</h3>
            <table>
                <thead>
                    <tr>
                        <th>Columbary Name</th>
                        <th>Location</th>
                        <th>Capacity</th>
                        <th>Occupied By</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for columbary in occupied_columbaries %}
                    <tr>
                        <td>{{ columbary.vault_id }}</td>
                        <td>{{ columbary.section }}</td>
                        <td>{{ columbary.urns_per_columbary }}</td>
                        <td>{{ columbary.customer.full_name }}</td>
                        <td>{{ columbary.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Unissued Columbaries Table (Initially Hidden) -->
        <div id="unissuedTableContainer" class="table-container hidden">
            <h3>UNISSUED COLUMBARIES</h3>
            <table>
                <thead>
                    <tr>
                        <th>Vault ID</th>
                        <th>Issuance Date</th>
                        <th>Customer</th>
                    </tr>
                </thead>
                <tbody>
                    {% for columbary in unissued_columbary_records %}
                    <tr>
                        <td>{{ columbary.vault_id }}</td>
                        <td>{{ columbary.issuance_date }}</td>
                        <td>{{ columbary.customer.full_name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No unissued columbaries found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container">
                <h2>PAYMENT DISTRIBUTION</h2>
                <canvas id="paymentChart" width="300" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h2>TOTAL EARNINGS OVER TIME</h2>
                <canvas id="earningsChart"></canvas>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

        <!-- Hidden elements to store filtered earnings data -->
        <span id="earnings_labels" style="display: none;">{{ earnings_labels|safe }}</span>
        <span id="earnings_data" style="display: none;">{{ earnings_data|safe }}</span>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var ctx = document.getElementById("paymentChart").getContext("2d");

                var paymentChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: {{ payment_labels| safe }},
                datasets: [{
                    data: {{ payment_data| safe }},
                backgroundColor: ["#36A2EB", "#FFCE56"],
            }]
        },
                options: {
                responsive: true,
                maintainAspectRatio: true, // Keep aspect ratio
                aspectRatio: 1, // Ensure it's square
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: "#ffffff",
                            font: { size: 16 }
                        }
                    },
                    datalabels: {  // Enable the plugin for showing percentages
                        formatter: (value, ctx) => {
                            let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = ((value / sum) * 100).toFixed(2) + "%";
                            return percentage;
                        },
                        color: "#ffffff", // Percentage text color
                        font: { size: 30, weight: 'normal', family: 'Impact' }
                    }
                }
            },
                plugins: [ChartDataLabels] // Activate the plugin
    });
});

            var earningsChart = null;  // ðŸ”¥ Ensure it's globally defined

            document.addEventListener("DOMContentLoaded", function () {
                var earningsCtx = document.getElementById("earningsChart").getContext("2d");

                earningsChart = new Chart(earningsCtx, {  // âœ… Assign globally
                    type: "line",
                    data: {
                        labels: JSON.parse(document.getElementById("earnings_labels").textContent),
                        datasets: [{
                            label: "Earnings (â‚±)",
                            data: JSON.parse(document.getElementById("earnings_data").textContent),
                            borderColor: "#36A2EB",
                            backgroundColor: "rgba(54, 162, 235, 0.2)",
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: "#36A2EB"
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: "#ffffff",
                                    callback: function (value) {
                                        return "â‚±" + value.toLocaleString("en-PH");
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    color: "#ffffff"
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        let value = tooltipItem.raw;
                                        return "â‚±" + value.toLocaleString("en-PH");
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: "#ffffff",
                                    font: { size: 16 }
                                }
                            },
                            title: {
                                display: true,
                                text: "Total Earnings (â‚±) Over Time",
                                color: "#ffffff",
                                font: { size: 18 }
                            }
                        }
                    }
                });
            });



            function updateCustomerStatus(customerId, action) {
                let confirmationMessage = action === "accept"
                    ? "Are you sure you want to accept this letter of intent?"
                    : "Are you sure you want to decline this letter of intent?";

                if (!confirm(confirmationMessage)) {
                    return; // Stop if the user clicks "Cancel"
                }

                let url = action === "accept"
                    ? `/accept/${customerId}/`
                    : `/decline/${customerId}/`;

                fetch(url, {
                    method: "GET",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert(`Letter of Intent ${data.new_status.toUpperCase()} successfully!`);
                            location.reload(); // ðŸ”¥ Refresh the page to reflect changes
                        } else {
                            alert("Error updating status. Please try again.");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("An error occurred. Please try again.");
                    });
            }

            document.getElementById("dateFilterForm").addEventListener("submit", function (event) {
                event.preventDefault(); // Prevent full page reload

                let formData = new FormData(this);
                let url = this.action + "?" + new URLSearchParams(formData).toString();

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        console.log("AJAX Response:", html); // ðŸ”¥ Debug response

                        let parser = new DOMParser();
                        let doc = parser.parseFromString(html, "text/html");

                        let earningsLabelsElement = doc.getElementById("earnings_labels");
                        let earningsDataElement = doc.getElementById("earnings_data");

                        if (earningsLabelsElement && earningsDataElement) {
                            let newEarningsLabels = JSON.parse(earningsLabelsElement.textContent);
                            let newEarningsData = JSON.parse(earningsDataElement.textContent);

                            console.log("Filtered Earnings Labels:", newEarningsLabels);
                            console.log("Filtered Earnings Data:", newEarningsData);

                            // âœ… Destroy existing chart before recreating
                            if (earningsChart) {
                                earningsChart.destroy();
                                console.log("Previous earningsChart destroyed.");
                            }

                            // âœ… Recreate chart
                            var earningsCtx = document.getElementById("earningsChart").getContext("2d");
                            earningsChart = new Chart(earningsCtx, {
                                type: "line",
                                data: {
                                    labels: newEarningsLabels,
                                    datasets: [{
                                        label: "Earnings (â‚±)",
                                        data: newEarningsData,
                                        borderColor: "#36A2EB",
                                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                                        borderWidth: 2,
                                        pointRadius: 5,
                                        pointBackgroundColor: "#36A2EB"
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                color: "#ffffff",
                                                callback: function (value) {
                                                    return "â‚±" + value.toLocaleString("en-PH");
                                                }
                                            }
                                        },
                                        x: {
                                            ticks: {
                                                color: "#ffffff"
                                            }
                                        }
                                    },
                                    plugins: {
                                        tooltip: {
                                            callbacks: {
                                                label: function (tooltipItem) {
                                                    let value = tooltipItem.raw;
                                                    return "â‚±" + value.toLocaleString("en-PH");
                                                }
                                            }
                                        },
                                        legend: {
                                            labels: {
                                                color: "#ffffff",
                                                font: { size: 16 }
                                            }
                                        },
                                        title: {
                                            display: true,
                                            text: "Total Earnings (â‚±) Over Time",
                                            color: "#ffffff",
                                            font: { size: 18 }
                                        }
                                    }
                                }
                            });

                            console.log("New earningsChart created.");
                        } else {
                            console.error("Error: earnings_labels or earnings_data element not found in AJAX response.");
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });



            function toggleTable() {
                var tableContainer = document.getElementById("pendingTableContainer");
                tableContainer.classList.toggle("hidden");
            }

            function toggleAvailableTable() {
                var availableTable = document.getElementById("availableTableContainer");
                availableTable.classList.toggle("hidden");
            }

            function toggleOccupiedTable() {
                var occupiedTable = document.getElementById("occupiedTableContainer");
                occupiedTable.classList.toggle("hidden");
            }

            function toggleUnissuedTable() {
                var unissuedTable = document.getElementById("unissuedTableContainer");
                unissuedTable.classList.toggle("hidden");
            }
        </script>
</body>

</html>