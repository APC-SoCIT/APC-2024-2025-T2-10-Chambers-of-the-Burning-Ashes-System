{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Columbary Record</title>
    <link rel="stylesheet" href="{% static 'css/addnewrecord.css' %}">
    <script type="text/javascript">
        function togglePaymentFields() {
            const paymentMode = document.getElementById("id_mode_of_payment").value;
            const fullPaymentFields = document.getElementById("full_payment_fields");
            const sixMonthFields = document.getElementById("six_month_fields");

            if (paymentMode === "Full Payment") {
                fullPaymentFields.style.display = "block";
                sixMonthFields.style.display = "none";
            } else if (paymentMode === "6-Month Installment") {
                fullPaymentFields.style.display = "none";
                sixMonthFields.style.display = "block";
            } else {
                fullPaymentFields.style.display = "none";
                sixMonthFields.style.display = "none";
            }
        }

        document.getElementById('processOCR').addEventListener('click', function() {
    const fileInput = document.getElementById('ocrInput');
    if (!fileInput.files.length) {
        alert('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('document', fileInput.files[0]);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('/process-ocr/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Populate form fields with extracted data
            document.querySelector('[name="first_name"]').value = data.data.full_name || '';
            document.querySelector('[name="permanent_address"]').value = data.data.permanent_address || '';
            document.querySelector('[name="mobile_number"]').value = data.data.mobile_number || '';
            document.querySelector('[name="email_address"]').value = data.data.email_address || '';
            document.querySelector('[name="first_beneficiary_name"]').value = data.data.first_beneficiary_name || '';
            document.querySelector('[name="vault_id"]').value = data.data.vault_id || '';
        } else {
            alert('Error processing document: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
});
        window.onload = function() {
            togglePaymentFields();
        }        
    </script>

</head>
<body>

    <div class="container">
        <h2>Add New Columbary Record</h2>
        <div class="ocr-section">
            <h3>Document Capture</h3>
            <div class="capture-options">
                <button type="button" id="webcamOption">Use Webcam</button>
                <button type="button" id="uploadOption">Upload File</button>
            </div>
        
            <!-- Webcam Interface -->
            <div id="webcam-container" style="display: none;">
                <video id="webcam-view" autoplay playsinline></video>
                <button type="button" id="captureButton">Capture</button>
                <canvas id="captured-image" style="display: none;"></canvas>
            </div>
        
            <!-- File Upload Interface -->
            <div id="fileUploadContainer">
                <input type="file" id="ocrInput" accept="image/*">
                <button type="button" id="processOCR">Process with OCR</button>
            </div>

        <!-- Display Form Errors -->
        {% if customer_form.errors or payment_form.errors or columbary_form.errors or holder_form.errors or beneficiary_form.errors %}
        <div class="alert alert-danger">
            <strong>There were errors in your submission. Please check the fields and try again.</strong>
        </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            
            <h3>Customer Information</h3>
            <div class="form-group">
                {{ customer_form.as_p }}
            </div>

            <h3>Mode of Payment:</h3>
            {{ payment_form.mode_of_payment }}
            
            <!-- Full Payment Fields -->
            <div id="full_payment_fields" style="display: none;">
                <h4>Full Payment Details</h4>
                
                <label for="id_Full_payment_receipt_1">Receipt #1:</label>
                {{ payment_form.Full_payment_receipt_1 }}
            
                <label for="id_Full_payment_amount_1">Amount:</label>
                {{ payment_form.Full_payment_amount_1 }}
            </div>
            
            <!-- 6-Month Installment Fields -->
            <div id="installment_payment_fields" style="display: none;">
                <h4>6-Month Installment Details</h4>
            
                <div class="installment-group">
                    <label for="id_six_month_receipt_1">Receipt #1:</label>
                    {{ payment_form.six_month_receipt_1 }}
                    <label for="id_six_month_amount_1">Amount:</label>
                    {{ payment_form.six_month_amount_1 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_2">Receipt #2:</label>
                    {{ payment_form.six_month_receipt_2 }}
                    <label for="id_six_month_amount_2">Amount:</label>
                    {{ payment_form.six_month_amount_2 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_3">Receipt #3:</label>
                    {{ payment_form.six_month_receipt_3 }}
                    <label for="id_six_month_amount_3">Amount:</label>
                    {{ payment_form.six_month_amount_3 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_4">Receipt #4:</label>
                    {{ payment_form.six_month_receipt_4 }}
                    <label for="id_six_month_amount_4">Amount:</label>
                    {{ payment_form.six_month_amount_4 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_5">Receipt #5:</label>
                    {{ payment_form.six_month_receipt_5 }}
                    <label for="id_six_month_amount_5">Amount:</label>
                    {{ payment_form.six_month_amount_5 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_6">Receipt #6:</label>
                    {{ payment_form.six_month_receipt_6 }}
                    <label for="id_six_month_amount_6">Amount:</label>
                    {{ payment_form.six_month_amount_6 }}
                </div>
            </div>

            <h3>Columbary Record</h3>
            <div class="form-group">
                {{ columbary_form.as_p }}
            </div>

            <h3>Holder of Privilege</h3>
            <div class="form-group">
                {{ holder_form.as_p }}
            </div>

            <h3>Beneficiaries</h3>
            <div class="form-group">
                {{ beneficiary_form.as_p }}
            </div>

            <button type="submit" class="btn btn-primary">Submit Record</button>

            <!-- Go Back Button -->
            <a href="{% url 'columbaryrecords' %}" class="btn btn-secondary" style="margin-left: 10px;">Go Back</a>
        </form>
    </div>

    <!-- Link to JavaScript File -->
    <script src="{% static 'js/addnewrecord.js' %}"></script>
</body>
</html>
