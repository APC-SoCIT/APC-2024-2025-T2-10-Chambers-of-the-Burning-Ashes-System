{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Columbary Record</title>
    <link rel="stylesheet" href="{% static 'css/addnewrecord.css' %}">
    <script type="text/javascript">
        function togglePaymentFields() {
            const paymentMode = document.getElementById("id_mode_of_payment").value;
            const fullPaymentFields = document.getElementById("full_payment_fields");
            const sixMonthFields = document.getElementById("six_month_fields");

            if (paymentMode === "Full Payment") {
                fullPaymentFields.style.display = "block";
                sixMonthFields.style.display = "none";
            } else if (paymentMode === "6-Month Installment") {
                fullPaymentFields.style.display = "none";
                sixMonthFields.style.display = "block";
            } else {
                fullPaymentFields.style.display = "none";
                sixMonthFields.style.display = "none";
            }
        }

        document.getElementById('processOCR').addEventListener('click', function() {
            const fileInput = document.getElementById('ocrInput');
            if (!fileInput.files.length) {
                alert('Please select a file first');
                return;
            }
            
            const formData = new FormData();
            formData.append('document', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            
            const button = this;
            button.innerHTML = 'Processing...';
            button.classList.add('ocr-processing');
            button.disabled = true;
            
            fetch('/process-ocr/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    const nameparts = data.data.full_name.split(' ');
                    if (nameparts.length > 0) {
                        document.querySelector('[name="first_name"]').value = nameparts[0] || '';
                        if (nameparts.length > 1) {
                            document.querySelector('[name="last_name"]').value = nameparts[nameparts.length - 1] || '';
                        }
                        if (nameparts.length > 2) {
                            document.querySelector('[name="middle_name"]').value = nameparts.slice(1, -1).join(' ') || '';
                        }
                    }
                    
                    
                    const addressParts = data.data.permanent_address.split(',');
                    if (addressParts.length > 0) {
                        document.querySelector('[name="address_line_1"]').value = addressParts[0].trim() || '';
                        if (addressParts.length > 1) {
                            document.querySelector('[name="city"]').value = addressParts[1].trim() || '';
                        }
                        if (addressParts.length > 2) {
                            document.querySelector('[name="province_or_state"]').value = addressParts[2].trim() || '';
                        }
                    }
                    
                    
                    document.querySelector('[name="mobile_number"]').value = data.data.mobile_number || '';
                    document.querySelector('[name="landline_number"]').value = data.data.landline_number || '';
                    document.querySelector('[name="email_address"]').value = data.data.email_address || '';
                    
                    
                    document.querySelector('[name="first_beneficiary_name"]').value = data.data.first_beneficiary_name || '';
                    document.querySelector('[name="second_beneficiary_name"]').value = data.data.second_beneficiary_name || '';
                    document.querySelector('[name="third_beneficiary_name"]').value = data.data.third_beneficiary_name || '';
                    
                    
                    document.querySelector('[name="vault_id"]').value = data.data.vault_id || '';
                    document.querySelector('[name="issuance_date"]').value = data.data.issuance_date || '';
                    document.querySelector('[name="expiration_date"]').value = data.data.expiration_date || '';
                    document.querySelector('[name="inurnment_date"]').value = data.data.inurnment_date || '';
                    document.querySelector('[name="issuing_parish_priest"]').value = data.data.issuing_parish_priest || '';
                    document.querySelector('[name="urns_per_columbary"]').value = data.data.urns_per_columbary || '';
                    
                } else {
                    alert('Error processing document: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            })
            .finally(() => {
                
                button.innerHTML = 'Process with OCR';
                button.classList.remove('ocr-processing');
                button.disabled = false;
            });
        });

        window.onload = function() {
            togglePaymentFields();
        }        
    </script>

</head>
<body>

    <div class="container">
        <h2>Add New Columbary Record</h2>
        <div class="ocr-section">
            <h3>Upload Document for Auto-Fill</h3>
            <div class="ocr-upload">
                <input type="file" id="ocrInput" accept="image/*" class="ocr-input">
                <button type="button" id="processOCR" class="ocr-button">Process with OCR</button>
            </div>
            <small class="ocr-help">Upload a clear image of the handwritten form to auto-fill fields</small>
        </div>
        <form method="POST">

        <!-- Display Form Errors -->
        {% if customer_form.errors or payment_form.errors or columbary_form.errors or holder_form.errors or beneficiary_form.errors %}
        <div class="alert alert-danger">
            <strong>There were errors in your submission. Please check the fields and try again.</strong>
        </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            
            <h3>Customer Information</h3>
            <div class="form-group">
                {{ customer_form.as_p }}
            </div>

            <h3>Mode of Payment:</h3>
            {{ payment_form.mode_of_payment }}
            
            <!-- Full Payment Fields -->
            <div id="full_payment_fields" style="display: none;">
                <h4>Full Payment Details</h4>
                
                <label for="id_Full_payment_receipt_1">Receipt #1:</label>
                {{ payment_form.Full_payment_receipt_1 }}
            
                <label for="id_Full_payment_amount_1">Amount:</label>
                {{ payment_form.Full_payment_amount_1 }}
            </div>
            
            <!-- 6-Month Installment Fields -->
            <div id="installment_payment_fields" style="display: none;">
                <h4>6-Month Installment Details</h4>
            
                <div class="installment-group">
                    <label for="id_six_month_receipt_1">Receipt #1:</label>
                    {{ payment_form.six_month_receipt_1 }}
                    <label for="id_six_month_amount_1">Amount:</label>
                    {{ payment_form.six_month_amount_1 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_2">Receipt #2:</label>
                    {{ payment_form.six_month_receipt_2 }}
                    <label for="id_six_month_amount_2">Amount:</label>
                    {{ payment_form.six_month_amount_2 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_3">Receipt #3:</label>
                    {{ payment_form.six_month_receipt_3 }}
                    <label for="id_six_month_amount_3">Amount:</label>
                    {{ payment_form.six_month_amount_3 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_4">Receipt #4:</label>
                    {{ payment_form.six_month_receipt_4 }}
                    <label for="id_six_month_amount_4">Amount:</label>
                    {{ payment_form.six_month_amount_4 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_5">Receipt #5:</label>
                    {{ payment_form.six_month_receipt_5 }}
                    <label for="id_six_month_amount_5">Amount:</label>
                    {{ payment_form.six_month_amount_5 }}
                </div>
                <div class="installment-group">
                    <label for="id_six_month_receipt_6">Receipt #6:</label>
                    {{ payment_form.six_month_receipt_6 }}
                    <label for="id_six_month_amount_6">Amount:</label>
                    {{ payment_form.six_month_amount_6 }}
                </div>
            </div>

            <h3>Columbary Record</h3>
            <div class="form-group">
                {{ columbary_form.as_p }}
            </div>

            <h3>Holder of Privilege</h3>
            <div class="form-group">
                {{ holder_form.as_p }}
            </div>

            <h3>Beneficiaries</h3>
            <div class="form-group">
                {{ beneficiary_form.as_p }}
            </div>

            <button type="submit" class="btn btn-primary">Submit Record</button>

            <!-- Go Back Button -->
            <a href="{% url 'columbaryrecords' %}" class="btn btn-secondary" style="margin-left: 10px;">Go Back</a>
        </form>
    </div>

    <!-- Link to JavaScript File -->
    <script src="{% static 'js/addnewrecord.js' %}"></script>
</body>
</html>
